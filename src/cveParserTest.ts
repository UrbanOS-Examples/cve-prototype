import hardBrakingData from './hard_braking_event.json';

export function cveTest() {
    let cveEvent: string;
    let jsonCVEEVent: JSON;
    let jsonMsgBody: JSON;
    let longAccelFtS2: number;
    let lat: number;
    let long: number;
    let vehicleId: number;
    let heading: number;
    let shouldAlert: boolean;

    shouldAlert=false;
    for (const key in hardBrakingData) {
        cveEvent = JSON.stringify(hardBrakingData[key]);
        jsonCVEEVent = JSON.parse(cveEvent);

        if (jsonCVEEVent == null) {
            console.log('null')
            return;
        }

        Object.entries(jsonCVEEVent).forEach(([key, value]) => {
            if (key === 'messagetype' ) {
                if (value === 'BSM') {                    
                    //console.log("BSM Message\n") 
                }
                else {
                    console.log("Ignoring Message Type")
                }
            }
            if (key === 'messagebody' ) {
                jsonMsgBody = JSON.parse(value);
                Object.entries(jsonMsgBody).forEach(([jKey, jValue]) => {
                    if (jKey === 'coreData') {
                        Object.entries(jValue).forEach(([cKey, cValue]) => {
                            if (cKey === 'id') {
                                vehicleId = cValue as number;
                            }
                            if (cKey === 'accelSet') {
                                Object.entries(cValue).forEach(([aKey, aValue]) => {
                                    if (aKey === 'long') {
                                        longAccelFtS2 = (aValue as number) / 100 * 3.2808399
                                        if (longAccelFtS2 < -15) {
                                            shouldAlert = true
                                        } 
                                    }
                                })
                            }
                            if (cKey === 'lat') {
                                lat = (cValue as number) / 10000000
                            }
                            if (cKey === 'long') {
                                long = (cValue as number) / 10000000;
                            }
                            if (cKey === 'heading') {
                                heading = (cValue as number) / 80;
                            }
                        })
                    }
                })
                if (shouldAlert) {
                    console.log('Hard Braking Event ' )
                    console.log('Vehicle: '+vehicleId)
                    console.log('Location: '+lat, ','+long)
                    shouldAlert = false;
                }
            }
        })
    }
}

cveTest()